---
import { getCollection } from "astro:content";

const musicPosts = await getCollection(
  "blog",
  ({ data }) => data.draft !== true && data.tags?.includes("music")
);

const nowPlayingPosts = musicPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3)
  .map((post) => {
    const spotifyMatch = post.body?.match(
      /https?:\/\/open\.spotify\.com\/[^\s)"']+/i
    );
    const fallbackSpotifyUrl = `https://open.spotify.com/search/${encodeURIComponent(
      post.data.title
    )}`;

    return {
      ...post,
      formattedDate: post.data.date.toLocaleDateString(undefined, {
        month: "short",
        day: "numeric",
        year: "numeric"
      }),
      spotifyUrl: spotifyMatch?.[0] ?? fallbackSpotifyUrl
    };
  });
---

<section id="music" class="border-b border-white/20 divide-y divide-white/20">
  <div class="px-8 py-6 relative">
    <h2 class="text-3xl font-black text-white uppercase">Now Playing</h2>
    <p class="text-sm text-slate-300">Current rotation—from the drive to the range to late-night listening.</p>
  </div>
  <div class="p-8 space-y-6">
    {nowPlayingPosts.length === 0 ? (
      <div class="empty-state bg-white/10">
        Nothing published yet. Toggle a blog post’s `draft: false` and tag it with `music` to populate this block.
      </div>
    ) : (
      <div class="grid gap-5 md:grid-cols-3">
        {nowPlayingPosts.map((post) => (
          <article class="flex h-full flex-col gap-4 rounded-2xl border border-white/20 bg-white/10 p-6 shadow-lg transition-colors duration-200 hover:border-white/40">
            <div class="flex-1 space-y-3">
              <div class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-300">
                {post.formattedDate}
              </div>
              <h3 class="text-lg font-black uppercase text-white">
                {post.data.title}
              </h3>
              <p class="text-sm text-slate-200">{post.data.summary}</p>
            </div>
            <a
              class="inline-flex items-center justify-center rounded-full border border-emerald-300/50 bg-emerald-500/10 px-6 py-2 text-sm font-semibold uppercase tracking-[0.16em] text-emerald-100 transition-colors duration-200 hover:bg-emerald-500/20"
              href={post.spotifyUrl}
              target="_blank"
              rel="noopener noreferrer"
            >
              Listen on Spotify
            </a>
          </article>
        ))}
      </div>
    )}
  </div>
</section>
